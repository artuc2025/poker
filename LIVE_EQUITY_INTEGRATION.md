# Live Equity Display - Интеграция

## Обзор

Live Equity Display — это система отображения шансов на выигрыш для каждого игрока в реальном времени. Система использует симуляцию Монте-Карло для расчета вероятности победы каждого игрока.

## Архитектура

### 1. Утилита расчета equity (`utils/equityCalculator.ts`)

**Основные функции:**

- `calculateEquity()` - основной алгоритм расчета
- `calculateQuickEquity()` - быстрый расчет для UI (1000 симуляций)
- `calculateFullEquity()` - точный расчет (10000 симуляций)
- `simulateGame()` - симуляция одной игры
- `getKnownCards()` - сбор всех известных карт
- `createRemainingDeck()` - создание колоды без известных карт

**Алгоритм работы:**

1. Собираем все известные карты (личные карты игроков + общие карты)
2. Создаем колоду оставшихся карт
3. Проводим N симуляций (1000 или 10000)
4. В каждой симуляции:
   - Дополняем общие карты до 5 карт
   - Дополняем личные карты игроков до 2 карт
   - Определяем победителя
5. Подсчитываем процент побед для каждого игрока

### 2. Расширение store (`stores/poker.ts`)

**Новые поля в GameState:**

- `playerEquity: PlayerEquity[]` - equity для каждого игрока
- `isCalculatingEquity: boolean` - флаг расчета
- `lastEquityCalculation: number` - время последнего расчета

**Новые методы:**

- `calculateEquity()` - запуск расчета
- `updateEquity()` - автоматическое обновление
- `getPlayerEquity()` - получение equity игрока
- `shouldUpdateEquity` - проверка необходимости обновления

### 3. Компонент отображения (`components/EquityDisplay.vue`)

**Функциональность:**

- Отображение процентов для каждого игрока
- Прогресс-бары с цветовой индикацией
- Кнопка для точного расчета
- Анимация загрузки
- Адаптивный дизайн

**Цветовая схема:**

- Зеленый (≥50%) - высокие шансы
- Оранжевый (25-50%) - средние шансы
- Красный (<25%) - низкие шансы

## Интеграция в основной интерфейс

### Автоматическое обновление

- При раздаче карт игрокам (префлоп)
- При раздаче флопа (3 общие карты)
- При раздаче терна (4-я общая карта)
- При раздаче ривера (5-я общая карта)

### Watcher в основном компоненте

```typescript
watch(
  () => [
    gameState.players.map(p => p.cards),
    gameState.communityCards,
    gameState.currentRound,
  ],
  async () => {
    if (shouldUpdateEquity) {
      await updateEquity()
    }
  },
  { deep: true }
)
```

## Производительность

### Оптимизации:

- **Кэширование**: Минимум 1 секунда между расчетами
- **Быстрый расчет**: 1000 симуляций для UI
- **Точный расчет**: 10000 симуляций по запросу
- **Асинхронность**: Неблокирующий UI

### Ограничения:

- Расчет только для активных игроков
- Расчет только при наличии карт
- Защита от множественных одновременных расчетов

## Тестирование

### Unit тесты (`tests/unit/utils/equityCalculator.test.ts`)

- Тестирование сбора известных карт
- Тестирование создания оставшейся колоды
- Тестирование расчета equity
- Тестирование граничных случаев

## Использование

### Для разработчиков:

1. Импортируйте `calculateQuickEquity` или `calculateFullEquity`
2. Передайте игроков и общие карты
3. Получите результат с equity для каждого игрока

### Для пользователей:

1. Раздайте карты игрокам
2. Equity автоматически обновится
3. Нажмите "Точный расчет" для более точных результатов

## Будущие улучшения

1. **Кэширование результатов** - сохранение расчетов для одинаковых ситуаций
2. **Web Workers** - вынос расчетов в отдельный поток
3. **Прогрессивный расчет** - показ промежуточных результатов
4. **Настройка точности** - пользовательский выбор количества симуляций
5. **История equity** - график изменения шансов во времени
